<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DonkeyChat - Secure P2P</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        :root {
            --bg-color: #09090b;
            --surface: #18181b;
            --surface-hover: #27272a;
            --border: #3f3f46;
            --text-main: #fafafa;
            --text-muted: #a1a1aa;
            --brand-red: #ef4444;
            --brand-red-hover: #dc2626;
            --red-glow: rgba(239, 68, 68, 0.15);
            --radius-md: 12px;
            --radius-lg: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5), 0 0 40px var(--red-glow);
            max-width: 540px;
            width: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header { padding: 32px 32px 24px; text-align: center; border-bottom: 1px solid var(--border); }
        .header h1 { font-size: 24px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        #setupScreen { padding: 32px; display: flex; flex-direction: column; gap: 24px; }
        #chatScreen { display: none; height: 600px; flex-direction: column; }

        .input-group { display: flex; flex-direction: column; gap: 8px; }
        input[type="text"] {
            width: 100%; background: var(--bg-color); border: 1px solid var(--border);
            color: var(--text-main); padding: 14px 16px; border-radius: var(--radius-md);
        }
        
        .btn-primary { background: var(--brand-red); color: white; border: none; padding: 14px; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; width: 100%; }
        .btn-secondary { background: var(--bg-color); color: var(--text-main); border: 1px solid var(--border); padding: 14px; border-radius: var(--radius-md); cursor: pointer; }

        #installBanner {
            background: var(--surface-hover);
            border: 1px solid var(--brand-red);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            display: none;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .code-box { background: var(--bg-color); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 24px; text-align: center; }
        .code-digits { font-family: monospace; font-size: 48px; color: var(--brand-red); letter-spacing: 8px; margin: 12px 0; }

        /* Chat Styles */
        .chat-messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; background: var(--bg-color); }
        .msg-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .msg-wrapper.sent { align-self: flex-end; }
        .msg { padding: 12px 16px; border-radius: 16px; font-size: 14px; }
        .sent .msg { background: var(--brand-red); color: white; }
        .received .msg { background: var(--surface); border: 1px solid var(--border); }
        .system { align-self: center; font-size: 12px; color: var(--text-muted); border: 1px dashed var(--border); padding: 4px 12px; border-radius: 20px; }

        .chat-input-area { padding: 20px; background: var(--surface); display: flex; gap: 12px; border-top: 1px solid var(--border); }
        .hidden { display: none !important; }
        
        .progress-wrap { margin-top: 8px; height: 4px; background: rgba(0,0,0,0.2); border-radius: 2px; }
        .progress-bar { height: 100%; width: 0%; background: var(--brand-red); transition: width 0.2s; }
        .file-msg { cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ü´è DonkeyChat</h1>
        <p style="color: var(--text-muted); font-size: 14px;">Secure P2P Network</p>
    </div>

    <div id="setupScreen">
        <div id="installBanner">
            <p style="font-size: 13px;">üì± Install as App</p>
            <button class="btn-primary" style="width: auto; padding: 6px 12px;" onclick="triggerInstall()">Install</button>
        </div>

        <div id="serverStatus" style="text-align: center; font-size: 13px;">Connecting...</div>
        
        <input type="text" id="nickInput" placeholder="Enter Nickname...">

        <div style="display: flex; gap: 10px;">
            <button class="btn-primary" id="createBtn" onclick="createRoom()" disabled>Create Room</button>
            <button class="btn-secondary" id="joinBtn" onclick="toggleJoin()" disabled>Join</button>
        </div>

        <div id="codeBox" class="code-box hidden">
            <div class="code-digits" id="codeDisplay">------</div>
            <button class="btn-secondary" style="width: 100%" onclick="copyCode()">Copy Code</button>
        </div>

        <div id="joinSection" class="hidden">
            <input type="text" id="joinInput" placeholder="Enter 6-digit code" maxlength="6">
            <button class="btn-primary" onclick="joinRoom()" style="margin-top: 10px;">Connect P2P</button>
        </div>
    </div>

    <div id="chatScreen">
        <div style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;">
            <div id="chatSubtext">Securing Connection...</div>
            <button onclick="location.reload()" style="background: none; border: none; color: var(--brand-red); cursor: pointer;">Exit</button>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <button onclick="document.getElementById('fileInput').click()" id="attachBtn" disabled>üìé</button>
            <input type="text" id="msgInput" placeholder="Type message..." disabled onkeydown="if(event.key==='Enter')sendMessage()">
            <button class="btn-primary" id="sendBtn" style="width: auto; padding: 0 20px;" onclick="sendMessage()" disabled>Send</button>
        </div>
        <input type="file" id="fileInput" class="hidden" onchange="sendFile()">
    </div>
</div>

<script>
// --- CONFIG ---
const WS_URL = 'wss://chat-st99.onrender.com';
let ws, pc, dataChannel;
let myNick = '', peerNick = 'Peer', isInitiator = false;
let iceQueue = [], receiveBuffer = [], receivedBytes = 0, incomingMeta = null;

const rtcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { 
            urls: ['turn:openrelay.metered.ca:80', 'turn:openrelay.metered.ca:443'], 
            username: 'openrelayproject', credential: 'openrelayproject' 
        }
    ]
};

// --- SIGNALING ---
function connectWS() {
    ws = new WebSocket(WS_URL);
    ws.onopen = () => {
        document.getElementById('serverStatus').innerText = '‚úÖ Server Online';
        document.getElementById('createBtn').disabled = false;
        document.getElementById('joinBtn').disabled = false;
    };
    ws.onmessage = async (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'created') {
            document.getElementById('codeDisplay').innerText = msg.code;
            document.getElementById('codeBox').classList.remove('hidden');
        } else if (msg.type === 'peer_joined') {
            isInitiator = msg.initiator;
            await initWebRTC();
            showChat();
        } else if (msg.type === 'relay') {
            handleWebRTCSignal(msg.data);
        }
    };
}

// --- WebRTC ---
async function initWebRTC() {
    if (pc) return;
    pc = new RTCPeerConnection(rtcConfig);
    pc.onicecandidate = (e) => e.candidate && relaySignal({ type: 'ice', candidate: e.candidate });

    if (isInitiator) {
        dataChannel = pc.createDataChannel('donkeyData');
        setupDataChannel();
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        relaySignal({ type: 'offer', sdp: pc.localDescription });
    } else {
        pc.ondatachannel = (e) => { dataChannel = e.channel; setupDataChannel(); };
    }
}

async function handleWebRTCSignal(data) {
    if (!pc) await initWebRTC();
    if (data.type === 'offer') {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        relaySignal({ type: 'answer', sdp: pc.localDescription });
        processIceQueue();
    } else if (data.type === 'answer') {
        await pc.setRemoteDescription(new RTCSessionDescription(data.sdp));
        processIceQueue();
    } else if (data.type === 'ice') {
        pc.remoteDescription ? pc.addIceCandidate(data.candidate) : iceQueue.push(data.candidate);
    }
}

function processIceQueue() {
    while (iceQueue.length > 0) pc.addIceCandidate(iceQueue.shift());
}

function setupDataChannel() {
    dataChannel.onopen = () => {
        enableChat(true);
        document.getElementById('chatSubtext').innerText = 'üü¢ P2P Secured';
        dataChannel.send(JSON.stringify({ kind: 'nick', nick: myNick }));
    };
    dataChannel.onmessage = (e) => {
        if (typeof e.data === 'string') {
            const d = JSON.parse(e.data);
            if (d.kind === 'chat') addMsg(d.text, 'received', peerNick);
            if (d.kind === 'nick') { 
                peerNick = d.nick;
                document.getElementById('chatSubtext').innerHTML = `Connected: <b>${esc(peerNick)}</b>`;
            }
            if (d.kind === 'file-meta') { 
                incomingMeta = d; receiveBuffer = []; receivedBytes = 0; 
                appendFileProgress(d, peerNick); 
            }
        } else {
            handleBuffer(e.data);
        }
    };
}

// --- HELPERS ---
function sendMessage() {
    const val = document.getElementById('msgInput').value;
    if (!val) return;
    dataChannel.send(JSON.stringify({ kind: 'chat', text: val }));
    addMsg(val, 'sent', 'Me');
    document.getElementById('msgInput').value = '';
}

function sendFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return;
    const id = 'f' + Date.now();
    dataChannel.send(JSON.stringify({ kind: 'file-meta', id, name: file.name, size: file.size }));
    
    // UI for sender
    const wrap = document.createElement('div');
    wrap.className = 'msg-wrapper sent';
    wrap.innerHTML = `<div class="msg">Sending ${file.name}...<div class="progress-wrap"><div class="progress-bar" id="bar-${id}"></div></div></div>`;
    appendToChat(wrap);

    const reader = new FileReader();
    let offset = 0;
    reader.onload = (e) => {
        dataChannel.send(e.target.result);
        offset += e.target.result.byteLength;
        document.getElementById('bar-'+id).style.width = (offset/file.size*100) + '%';
        if (offset < file.size) readSlice();
    };
    const readSlice = () => reader.readAsArrayBuffer(file.slice(offset, offset + 16384));
    readSlice();
}

function handleBuffer(data) {
    receiveBuffer.push(data);
    receivedBytes += data.byteLength;
    const bar = document.getElementById('bar-' + incomingMeta.id);
    if(bar) bar.style.width = (receivedBytes / incomingMeta.size * 100) + '%';
    
    if (receivedBytes === incomingMeta.size) {
        const url = URL.createObjectURL(new Blob(receiveBuffer));
        const barWrap = bar.parentElement;
        barWrap.innerHTML = `<button onclick="downloadFile('${url}','${incomingMeta.name}')">Download File</button>`;
    }
}

function downloadFile(url, name) {
    const a = document.createElement('a'); a.href = url; a.download = name; a.click();
}

function appendFileProgress(meta, sender) {
    const wrap = document.createElement('div');
    wrap.className = 'msg-wrapper received';
    wrap.innerHTML = `<div style="font-size:10px">${esc(sender)}</div><div class="msg">File: ${meta.name}<div class="progress-wrap"><div class="progress-bar" id="bar-${meta.id}"></div></div></div>`;
    appendToChat(wrap);
}

function createRoom() {
    myNick = document.getElementById('nickInput').value || 'User' + Math.floor(Math.random()*1000);
    ws.send(JSON.stringify({ type: 'create', code: Math.floor(100000 + Math.random()*899999).toString() }));
}

function joinRoom() {
    myNick = document.getElementById('nickInput').value || 'User' + Math.floor(Math.random()*1000);
    ws.send(JSON.stringify({ type: 'join', code: document.getElementById('joinInput').value }));
}

function relaySignal(data) { ws.send(JSON.stringify({ type: 'relay', data })); }
function esc(t) { const p = document.createElement('p'); p.textContent = t; return p.innerHTML; }
function toggleJoin() { document.getElementById('joinSection').classList.toggle('hidden'); }
function showChat() { document.getElementById('setupScreen').style.display='none'; document.getElementById('chatScreen').style.display='flex'; }
function enableChat(on) { ['msgInput', 'sendBtn', 'attachBtn'].forEach(id => document.getElementById(id).disabled = !on); }
function addMsg(t, s, n) { 
    const w = document.createElement('div'); w.className=`msg-wrapper ${s}`; 
    w.innerHTML = `<div style="font-size:10px">${n}</div><div class="msg">${esc(t)}</div>`;
    appendToChat(w);
}
function appendToChat(el) { const b = document.getElementById('chatMessages'); b.appendChild(el); b.scrollTop = b.scrollHeight; }
function copyCode() { navigator.clipboard.writeText(document.getElementById('codeDisplay').innerText); }

// PWA
let defP;
window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); defP = e; document.getElementById('installBanner').style.display = 'flex'; });
function triggerInstall() { if(defP) { defP.prompt(); document.getElementById('installBanner').style.display = 'none'; } }
if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});

connectWS();
</script>
</body>
</html>
